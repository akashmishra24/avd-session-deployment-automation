name: AVD Session Host Deployment
 
on:
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      vm_name:
        description: 'Name of the VM to create'
        required: true
        default: 'avd-vm-01'
      vm_size:
        description: 'VM size (e.g., Standard_D2s_v3)'
        required: true
        default: 'Standard_D2s_v3'
      resource_group:
        description: 'Resource group name'
        required: true
        default: 'AVD-RG'
      vnet_name:
        description: 'Virtual Network name'
        required: true
        default: 'avdsessionvnet'
      subnet_name:
        description: 'Subnet name'
        required: true
        default: 'subnet01'
      image:
        description: 'Image reference (e.g., MicrosoftWindowsDesktop:windows-11:win11-22h2-avd:latest)'
        required: true
        default: 'MicrosoftWindowsDesktop:Windows-11:win11-25h2-pro:latest'
       # default: '/subscriptions/548e32f7-f0a7-4af3-a856-130ec718c224/resourceGroups/rg-subsurfacevdi-np-001/providers/Microsoft.Compute/galleries/gal_subsurfacevdi_np_ae/images/win11-soe-ssv/versions/1.1.0'
      location:
        description: 'Azure location'
        required: true
        default: 'eastus'
      hostpool_name:
        description: 'AVD Host Pool name'
        required: true
        default: 'hostpool01'
      admin_username:
        description: 'VM admin username'
        required: true
        default: 'ssvadmin'
      admin_password:
        description: 'VM admin password'
        required: true
        type: string
        default: 'P@ssw0rd1234!'
 
jobs:
  deploy-avd-sessionhost:
    runs-on: ubuntu-latest
 
    permissions:
      id-token: write    # REQUIRED for OIDC
      contents: read
 
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Login to Azure via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
 
      - name: Verify Azure CLI context
        run: |
          echo "=== Azure Account Info ==="
          az account show --output table
          echo ""
          echo "=== Resource Groups ==="
          az group list --output table
 
      - name: Create Network Interface
        run: |
          echo "=== Getting Network Configuration ==="
          
          VNET_ID=$(az network vnet show \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.vnet_name }}" \
            --query id -o tsv)
          
          SUBNET_ID=$(az network vnet subnet show \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --vnet-name "${{ github.event.inputs.vnet_name }}" \
            --name "${{ github.event.inputs.subnet_name }}" \
            --query id -o tsv)
          
          echo "VNET_ID: $VNET_ID"
          echo "SUBNET_ID: $SUBNET_ID"
          
          echo "=== Creating Network Interface ==="
          az network nic create \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.vm_name }}-nic" \
            --location "${{ github.event.inputs.location }}" \
            --subnet "$SUBNET_ID" \
            --private-ip-address-version IPv4 \
            --output table
          
          echo "Network interface created successfully"
      
      - name: Create VM for AVD Session Host
        run: |
          echo "=== Creating VM: ${{ github.event.inputs.vm_name }} ==="
          
          az vm create \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.vm_name }}" \
            --image "${{ github.event.inputs.image }}" \
            --size "${{ github.event.inputs.vm_size }}" \
            --location "${{ github.event.inputs.location }}" \
            --authentication-type password \
            --admin-username "${{ github.event.inputs.admin_username }}" \
            --admin-password "${{ github.event.inputs.admin_password }}" \
            --nics "${{ github.event.inputs.vm_name }}-nic" \
            --public-ip-address "" \
            --output table
          
          echo "VM created successfully"
 
      - name: Generate AVD Registration Token
        run: |
          echo "=== Generating AVD Registration Token ==="
          
          # Get the host pool resource ID
          HOSTPOOL_ID=$(az desktopvirtualization hostpool list \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --query "[?name=='${{ github.event.inputs.hostpool_name }}'].id" \
            --output tsv)
          
          if [ -z "$HOSTPOOL_ID" ]; then
            echo "ERROR: Host pool '${{ github.event.inputs.hostpool_name }}' not found"
            exit 1
          fi
          
          echo "Host Pool ID: $HOSTPOOL_ID"
          echo "HOSTPOOL_ID=$HOSTPOOL_ID" >> $GITHUB_ENV
          
          # Create registration token (valid for 7 days)
          EXPIRATION_TIME=$(date -u -d '+7 days' '+%Y-%m-%dT%H:%M:%SZ')
          echo "Token expiration time: $EXPIRATION_TIME"
          
          # Update host pool and capture response
          HOSTPOOL_RESPONSE=$(az desktopvirtualization hostpool update \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.hostpool_name }}" \
            --registration-info registration-token-operation=Update \
            --registration-info expiration-time="$EXPIRATION_TIME" \
            --output json)
          
          # Extract the registration token from response
          REGISTRATION_TOKEN=$(echo "$HOSTPOOL_RESPONSE" | jq -r '.registrationInfo.token')
          
          if [ -z "$REGISTRATION_TOKEN" ] || [ "$REGISTRATION_TOKEN" = "null" ]; then
            echo "ERROR: Failed to extract registration token from response"
            echo "Response: $HOSTPOOL_RESPONSE"
            exit 1
          fi
          
          echo "Registration token generated successfully"
          echo "REGISTRATION_TOKEN=$REGISTRATION_TOKEN" >> $GITHUB_ENV
      
      - name: Install AVD Agent and Register Session Host
        run: |
          echo "=== Installing AVD Agent on VM ==="
          
          if [ -z "$REGISTRATION_TOKEN" ]; then
            echo "ERROR: Registration token is not available"
            exit 1
          fi
          
          echo "Registration token retrieved (length: ${#REGISTRATION_TOKEN})"
          
          # Install AVD Agent using custom script extension
          az vm run-command invoke \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.vm_name }}" \
            --command-id RunPowerShellScript \
            --scripts "
            # Set error action preference
            \$ErrorActionPreference = 'Stop'
            
            # Create temp directory
            \$tempDir = 'C:\Temp'
            if (!(Test-Path \$tempDir)) {
              New-Item -ItemType Directory -Path \$tempDir -Force | Out-Null
            }
            
            # Define the registration token
            \$registrationToken = '${REGISTRATION_TOKEN}'
            Write-Host \"Registration token length: \$(\$registrationToken.Length)\"
            
            # Download and install AVD Agent Boot Loader
            Write-Host 'Step 1: Downloading AVD Boot Loader...'
            \$bootLoaderUrl = 'https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrmXv'
            \$bootLoaderPath = Join-Path \$tempDir 'RDAgentBootLoaderInstaller.msi'
            
            try {
              Invoke-WebRequest -Uri \$bootLoaderUrl -OutFile \$bootLoaderPath -UseBasicParsing -ErrorAction Stop
              Write-Host \"Boot Loader downloaded: \$bootLoaderPath\"
            } catch {
              Write-Error \"Failed to download Boot Loader: \$_\"
              exit 1
            }
            
            # Install Boot Loader with token
            Write-Host 'Step 2: Installing AVD Boot Loader with registration token...'
            \$logFile = Join-Path \$tempDir 'bootloader_install.log'
            \$arguments = @(
              '/i', \$bootLoaderPath,
              '/qn',
              '/norestart',
              '/l*v', \$logFile,
              \"REGISTRATIONTOKEN=\`\"\$registrationToken\`\"\"
            )
            
            Write-Host \"Boot Loader install command: msiexec.exe \$(\$arguments -join ' ')\"
            \$process = Start-Process -FilePath 'msiexec.exe' -ArgumentList \$arguments -Wait -PassThru
            Write-Host \"Boot Loader install exit code: \$(\$process.ExitCode)\"
            
            if (Test-Path \$logFile) {
              Write-Host 'Boot Loader installation log:'
              Get-Content \$logFile | Write-Host
            }
            
            if (\$process.ExitCode -ne 0 -and \$process.ExitCode -ne 3010) {
              Write-Error \"Boot Loader installation failed with exit code: \$(\$process.ExitCode)\"
              exit 1
            }
            
            Write-Host 'Boot Loader installed successfully'
            
            # Wait for Boot Loader service to initialize
            Write-Host 'Waiting for Boot Loader service to initialize...'
            Start-Sleep -Seconds 10
            
            # Verify Boot Loader is installed
            if (Get-Service -Name 'RDAgentBootLoader' -ErrorAction SilentlyContinue) {
              Write-Host 'Boot Loader service found and active'
            }
            
            Write-Host 'AVD Agent installation configuration complete'
            Write-Host 'VM restart will be initiated to apply all changes'
            " || exit 1
          
          echo "AVD Agent Boot Loader installation completed"
      
      - name: Restart VM to Complete Registration
        run: |
          echo "=== Restarting VM to complete registration ==="
          
          # Restart the VM
          az vm restart \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.vm_name }}" \
            --no-wait
          
          echo "VM restart initiated"
          echo "Waiting for VM to restart and complete agent registration..."
          echo "Note: It may take 5-10 minutes for the session host to appear in the host pool"
          sleep 120
      
      - name: Verify Session Host
        run: |
          echo "=== Verifying Session Host Registration ==="
          
          # Wait for the VM to register (this can take a few minutes)
          sleep 30
          
          # List available session hosts in the host pool
          az desktopvirtualization hostpool show \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.hostpool_name }}" \
            --output table
 
      - name: Azure CLI logout
        if: always()
        run: |
          az logout
          az cache purge
          az account clear